<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#FF6B35">
    <title>ALISHASHOP Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; overscroll-behavior: none; }
        .gradient-orange { background: linear-gradient(135deg, #FF6B35 0%, #FF1493 100%); }
        .gradient-blue { background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); }
        .gradient-green { background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%); }
        .gradient-purple { background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); }
        .gradient-red { background: linear-gradient(135deg, #F44336 0%, #D32F2F 100%); }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-down { animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-scale { transition: transform 0.1s ease; }
        .animate-scale:active { transform: scale(0.95); }
        .bottom-nav-safe { padding-bottom: env(safe-area-inset-bottom); }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const formatCurrency = (amount) => new Intl.NumberFormat('fr-FR').format(amount) + ' FCFA';
        const generateId = (prefix) => `${prefix}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        
        const playAlertSound = () => {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(880, audioContext.currentTime + 0.5);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) { console.log('Son non disponible'); }
        };
        
        const getLast8Days = () => {
            const days = [];
            const today = new Date();
            for (let i = 0; i < 8; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                date.setHours(0, 0, 0, 0);
                days.push(date);
            }
            return days;
        };
        
        const formatDate = (date) => {
            const days = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
            const months = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'];
            return `${days[date.getDay()]} ${date.getDate()} ${months[date.getMonth()]}`;
        };
        
        const STORAGE_KEYS = {
            PRODUCTS: 'alishashop_products',
            TRANSACTIONS: 'alishashop_transactions',
            USERS: 'alishashop_users',
            SERVICES: 'alishashop_services'
        };

        /********** CONFIGURE ICI : REMPLACE LES DEUX LIGNES CI-DESSOUS PAR TES VALEURS SUPABASE **********/
        const SUPABASE_URL = ''; // ex: https://eonxlxoqgolqgitqddvo.supabase.co        const SUPABASE_KEY = ''; // ex: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVvbnhseG9xZ29scWdpdHFkZHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNzEyODAsImV4cCI6MjA3OTc0NzI4MH0.VoYakB5dO4WiPbcYZ-ucp8RrG_g60Uq4pZDOUIqDWVA'...
        /*************************************************************************************************/

        const remoteEnabled = SUPABASE_URL && SUPABASE_KEY;

        const StorageManager = {
            save: (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    window.dispatchEvent(new CustomEvent('storage-updated', { detail: { key } }));
                    return true;
                } catch (e) { console.error('Erreur sauvegarde:', e); return false; }
            },
            load: (key, defaultValue = null) => {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : defaultValue;
                } catch (e) { return defaultValue; }
            },

            loadAsync: async (key, defaultValue = null) => {
                if(!remoteEnabled) return StorageManager.load(key, defaultValue);
                try {
                    const table = key === STORAGE_KEYS.TRANSACTIONS ? 'transactions'
                                : key === STORAGE_KEYS.PRODUCTS ? 'products'
                                : key === STORAGE_KEYS.USERS ? 'users'
                                : key === STORAGE_KEYS.SERVICES ? 'services' : null;
                    if(!table) return StorageManager.load(key, defaultValue);

                    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?select=*`, {
                        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                    });
                    if(!res.ok) throw new Error(await res.text());
                    const rows = await res.json();
                    localStorage.setItem(key, JSON.stringify(rows));
                    return rows;
                } catch (e) {
                    console.warn('Remote load failed, using local cache', e);
                    return StorageManager.load(key, defaultValue);
                }
            },

            saveAsync: async (key, data) => {
                StorageManager.save(key, data);
                if(!remoteEnabled) return true;
                try {
                    const table = key === STORAGE_KEYS.TRANSACTIONS ? 'transactions'
                                : key === STORAGE_KEYS.PRODUCTS ? 'products'
                                : key === STORAGE_KEYS.USERS ? 'users'
                                : key === STORAGE_KEYS.SERVICES ? 'services' : null;
                    if(!table) return true;

                    // Upsert logic simple: POST array of rows (supabase prefer=merge duplicates)
                    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'resolution=merge-duplicates'
                        },
                        body: JSON.stringify(Array.isArray(data) ? data : [data])
                    });
                    if(!res.ok) throw new Error(await res.text());
                    return true;
                } catch (e) {
                    console.warn('Remote save failed', e);
                    return false;
                }
            },

            exportData: () => {
                const data = {
                    products: StorageManager.load(STORAGE_KEYS.PRODUCTS, []),
                    transactions: StorageManager.load(STORAGE_KEYS.TRANSACTIONS, []),
                    users: StorageManager.load(STORAGE_KEYS.USERS, []),
                    services: StorageManager.load(STORAGE_KEYS.SERVICES, []),
                    exportDate: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `alishashop-backup-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
        };

        const INITIAL_PRODUCTS = [
            { id: 'P001', name: 'Ecouteurs Bluetooth', stock: 12, price: 3500, category: 'High-Tech' },
            { id: 'P002', name: 'Câble USB Type-C', stock: 25, price: 1500, category: 'High-Tech' },
            { id: 'P003', name: 'Clé USB 32GB', stock: 4, price: 4500, category: 'High-Tech' },
            { id: 'P004', name: 'Rame Papier A4', stock: 3, price: 3500, category: 'Bureautique' },
            { id: 'P005', name: 'Stylo Bleu', stock: 50, price: 100, category: 'Bureautique' }
        ];
        
        const INITIAL_USERS = [
            { id: 'U001', name: 'Administrateur', pin: '1234', role: 'admin' },
            { id: 'U002', name: 'Caissier 1', pin: '0000', role: 'staff' }
        ];
        
        const INITIAL_SERVICES = [
            { id: 'S001', name: 'Photocopie N&B', price: 50, category: 'office' },
            { id: 'S002', name: 'Photocopie Couleur', price: 100, category: 'office' },
            { id: 'S003', name: 'Impression', price: 100, category: 'office' },
            { id: 'S004', name: 'Plastification', price: 500, category: 'office' },
            { id: 'S005', name: 'Reliure', price: 1000, category: 'office' },
            { id: 'S006', name: 'Scanner', price: 200, category: 'office' },
            { id: 'S007', name: "Photo d'identité", price: 2000, category: 'office' }
        ];
        
        const initializeData = () => {
            if (!StorageManager.load(STORAGE_KEYS.PRODUCTS)) {
                StorageManager.save(STORAGE_KEYS.PRODUCTS, INITIAL_PRODUCTS);
            }
            if (!StorageManager.load(STORAGE_KEYS.USERS)) {
                StorageManager.save(STORAGE_KEYS.USERS, INITIAL_USERS);
            }
            if (!StorageManager.load(STORAGE_KEYS.SERVICES)) {
                StorageManager.save(STORAGE_KEYS.SERVICES, INITIAL_SERVICES);
            }
            if (!StorageManager.load(STORAGE_KEYS.TRANSACTIONS)) {
                StorageManager.save(STORAGE_KEYS.TRANSACTIONS, []);
            }
        };
        
        const Toast = ({ message, type = 'success', onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 4000);
                return () => clearTimeout(timer);
            }, [onClose]);
            
            const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-orange-500', info: 'bg-blue-500' };
            const icons = { success: 'check-circle', error: 'x-circle', warning: 'alert-triangle', info: 'info' };
            
            return (
                <div className={`${colors[type]} text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 animate-slide-down`}>
                    <i data-lucide={icons[type]} className="w-6 h-6"></i>
                    <span className="flex-1 font-semibold">{message}</span>
                    <button onClick={onClose} className="p-1">
                        <i data-lucide="x" className="w-5 h-5"></i>
                    </button>
                </div>
            );
        };
        
        const ConfirmModal = ({ title, message, amount, onConfirm, onCancel, isWarning = false }) => {
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in">
                    <div className="bg-white rounded-3xl p-6 max-w-sm w-full shadow-2xl">
                        <div className="flex flex-col items-center text-center">
                            <div className={`w-20 h-20 rounded-full ${isWarning ? 'bg-red-100' : 'bg-green-100'} flex items-center justify-center mb-4`}>

                            <i data-lucide={isWarning ? 'alert-triangle' : 'shield-check'} className={`w-10 h-10 ${isWarning ? 'text-red-500' : 'text-green-500'}`}></i>
                            </div>
                            <h3 className="text-2xl font-black mb-2">{title}</h3>
                            <p className="text-gray-600 mb-2">{message}</p>
                            {amount && (
                                <div className={`text-3xl font-black ${isWarning ? 'text-red-600' : 'text-green-600'} mb-6`}>
                                    {formatCurrency(amount)}
                                </div>
                            )}
                            <div className="flex gap-3 w-full mt-4">
                                <button onClick={onCancel} className="flex-1 py-4 bg-gray-200 text-gray-700 rounded-2xl font-bold animate-scale">
                                    Annuler
                                </button>
                                <button onClick={onConfirm} className={`flex-1 py-4 text-white rounded-2xl font-bold animate-scale ${isWarning ? 'gradient-red' : 'gradient-green'}`}>
                                    Confirmer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        const LoginScreen = ({ onLogin }) => {
            const [selectedUser, setSelectedUser] = useState(null);
            const [pin, setPin] = useState('');
            const [error, setError] = useState('');
            const [users, setUsers] = useState([]);
            
            useEffect(() => {
                let mounted = true;
                (async () => {
                    const loadedUsers = await StorageManager.loadAsync(STORAGE_KEYS.USERS, []);
                    if(!mounted) return;
                    setUsers(loadedUsers);
                })();
            }, []);
            
            useEffect(() => { lucide.createIcons(); });
            
            const handleNumberClick = (num) => {
                if (pin.length < 4) {
                    const newPin = pin + num;
                    setPin(newPin);
                    if (newPin.length === 4) {
                        setTimeout(() => {
                            if (selectedUser && selectedUser.pin === newPin) {
                                onLogin(selectedUser);
                            } else {
                                setError('Code PIN incorrect');
                                setPin('');
                                setTimeout(() => setError(''), 2000);
                            }
                        }, 100);
                    }
                }
            };
            
            const handleDelete = () => {
                setPin(pin.slice(0, -1));
                setError('');
            };
            
            return (
                <div className="min-h-screen gradient-orange flex flex-col items-center justify-center p-4">
                    <div className="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl">
                        <div className="flex flex-col items-center mb-8">
                            <div className="w-24 h-24 gradient-orange rounded-3xl flex items-center justify-center shadow-xl mb-4">
                                <span className="text-white text-5xl font-black">A</span>
                            </div>
                            <h1 className="text-3xl font-black gradient-orange bg-clip-text text-transparent">ALISHASHOP</h1>
                            <p className="text-gray-500 text-sm">Manager</p>
                        </div>
                        
                        {!selectedUser ? (
                            <div>
                                <p className="text-center text-gray-600 mb-4 font-semibold">Sélectionnez votre profil</p>
                                <div className="space-y-3">
                                    {users.map(user => (
                                        <button key={user.id} onClick={() => setSelectedUser(user)}
                                            className="w-full p-4 bg-gradient-to-r from-orange-50 to-pink-50 rounded-2xl flex items-center gap-3 hover:shadow-lg transition-all animate-scale">
                                            <div className="w-12 h-12 gradient-orange rounded-xl flex items-center justify-center">
                                                <i data-lucide={user.role === 'admin' ? 'crown' : 'user'} className="text-white w-6 h-6"></i>
                                            </div>
                                            <div className="text-left flex-1">
                                                <p className="font-bold text-gray-800">{user.name}</p>
                                                <p className="text-xs text-gray-500 capitalize">{user.role === 'admin' ? 'Gérant' : 'Caissier'}</p>
                                            </div>
                                            <i data-lucide="chevron-right" className="text-gray-400 w-5 h-5"></i>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div>
                                <div className="flex items-center gap-3 mb-6 p-4 bg-gray-50 rounded-2xl">
                                    <div className="w-12 h-12 gradient-orange rounded-xl flex items-center justify-center">
                                        <i data-lucide={selectedUser.role === 'admin' ? 'crown' : 'user'} className="text-white w-6 h-6"></i>
                                    </div>
                                    <div className="flex-1">
                                        <p className="font-bold text-gray-800">{selectedUser.name}</p>
                                        <p className="text-xs text-gray-500 capitalize">{selectedUser.role === 'admin' ? 'Gérant' : 'Caissier'}</p>
                                    </div>
                                    <button onClick={() => { setSelectedUser(null); setPin(''); setError(''); }} className="p-2">
                                        <i data-lucide="x" className="text-gray-400 w-5 h-5"></i>
                                    </button>
                                </div>
                                <div className="mb-6">
                                    <p className="text-center text-gray-600 mb-4 font-semibold">Entrez votre code PIN</p>
                                    <div className="flex justify-center gap-3 mb-2">
                                        {[0, 1, 2, 3].map(i => (
                                            <div key={i} className={`w-14 h-14 rounded-2xl flex items-center justify-center ${pin.length > i ? 'gradient-orange' : 'bg-gray-200'}`}>
                                                {pin.length > i && <div className="w-4 h-4 bg-white rounded-full"></div>}
                                            </div>
                                        ))}
