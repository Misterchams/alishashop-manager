<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ALISHASHOP Ultra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700;900&display=swap');
        body { font-family: 'Roboto', sans-serif; background: #f0f2f5; -webkit-tap-highlight-color: transparent; }
        .glass { background: white; border-radius: 16px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); }
        .btn-press:active { transform: scale(0.95); }
        .scroll-hide::-webkit-scrollbar { display: none; }
        /* Couleurs Th√©matiques */
        .theme-orange { background: linear-gradient(135deg, #FF6B35 0%, #D9381E 100%); color: white; }
        .theme-blue { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; }
        .theme-purple { background: linear-gradient(135deg, #6f42c1 0%, #4e2c92 100%); color: white; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- OUTILS DE BASE ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const formatMoney = (n) => new Intl.NumberFormat('fr-FR').format(n) + ' FCFA';
        const todayStr = () => new Date().toLocaleDateString('fr-FR');

        // --- DONN√âES INITIALES ---
        const DEFAULT_SERVICES = [
            { id: 'S1', name: 'Photocopie N&B', price: 50, type: 'fixed' },
            { id: 'S2', name: 'Photocopie Couleur', price: 100, type: 'fixed' },
            { id: 'S3', name: 'Reliure GM', price: 1000, type: 'fixed' },
            { id: 'S4', name: 'Scanner', price: 200, type: 'fixed' },
            { id: 'S5', name: 'Impression', price: 100, type: 'fixed' },
            { id: 'S99', name: 'Service Sur Mesure', price: 0, type: 'libre' } // Prix libre
        ];

        // --- COMPOSANT : SCANNER ---
        const Scanner = ({ onScan, onClose }) => {
            useEffect(() => {
                const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
                scanner.render((txt) => { onScan(txt); scanner.clear(); onClose(); }, console.warn);
                return () => scanner.clear().catch(e=>{});
            }, []);
            return (
                <div className="fixed inset-0 bg-black z-50 flex flex-col justify-center p-4">
                    <div id="reader" className="bg-white rounded-lg"></div>
                    <button onClick={onClose} className="mt-4 bg-red-600 text-white p-4 rounded-lg font-bold">FERMER</button>
                </div>
            );
        };

        // --- COMPOSANT : LOGIN ---
        const LoginScreen = ({ onLogin }) => {
            const [pin, setPin] = useState("");
            const users = [{ name: 'Patron', pin: '1234', role: 'admin' }, { name: 'Vendeur', pin: '0000', role: 'staff' }];

            const handlePin = (n) => {
                const newPin = pin + n;
                setPin(newPin);
                if (newPin.length === 4) {
                    const u = users.find(u => u.pin === newPin);
                    if (u) onLogin(u);
                    else { alert("Code Faux"); setPin(""); }
                }
            };

            return (
                <div className="h-screen theme-orange flex flex-col items-center justify-center p-6">
                    <h1 className="text-4xl font-black mb-2">ALISHASHOP</h1>
                    <p className="mb-8 opacity-80">Acces S√©curis√©</p>
                    <div className="flex gap-2 mb-6 h-8">
                        {[0,1,2,3].map(i => <div key={i} className={`w-4 h-4 rounded-full ${pin.length > i ? 'bg-white':'bg-white/30'}`}></div>)}
                    </div>
                    <div className="grid grid-cols-3 gap-4 w-full max-w-xs">
                        {[1,2,3,4,5,6,7,8,9,0].map(n => (
                            <button key={n} onClick={() => handlePin(n)} className="h-20 glass text-2xl font-bold text-orange-600 btn-press">
                                {n}
                            </button>
                        ))}
                        <button onClick={() => setPin("")} className="col-span-2 h-20 bg-red-500 text-white rounded-xl font-bold btn-press">EFFACER</button>
                    </div>
                </div>
            );
        };

        // --- MODULE : BOUTIQUE (VENTE) ---
        const ShopModule = ({ products, onSale }) => {
            const [cart, setCart] = useState([]);
            const [search, setSearch] = useState("");
            const [scanning, setScanning] = useState(false);

            // Menu d√©roulant intelligent (Filtre les produits)
            const filtered = products.filter(p => p.name.toLowerCase().includes(search.toLowerCase()) && p.stock > 0);

            const addToCart = (p) => {
                const exists = cart.find(c => c.id === p.id);
                if(exists) {
                    if(exists.qty < p.stock) setCart(cart.map(c => c.id === p.id ? {...c, qty: c.qty+1} : c));
                    else alert("Stock Insuffisant !");
                } else setCart([...cart, {...p, qty: 1}]);
            };

            const validateSale = () => {
                if(cart.length === 0) return;
                const total = cart.reduce((acc, i) => acc + (i.price * i.qty), 0);
                if(confirm(`Encaisser ${formatMoney(total)} ?`)) {
                    onSale(cart, total);
                    setCart([]);
                    setSearch("");
                }
            };

            return (
                <div className="h-full flex flex-col">
                    {scanning && <Scanner onScan={(code) => {
                        const p = products.find(prod => prod.barcode === code);
                        if(p) { addToCart(p); alert(`${p.name} ajout√© !`); }
                        else alert("Produit inconnu");
                        setScanning(false);
                    }} onClose={()=>setScanning(false)} />}

                    {/* Barre de Recherche et Scan */}
                    <div className="p-4 bg-white shadow-sm flex gap-2">
                        <input value={search} onChange={e=>setSearch(e.target.value)} 
                            placeholder="Chercher un produit..." className="flex-1 bg-gray-100 p-3 rounded-xl font-bold outline-none border border-gray-300 focus:border-orange-500" />
                        <button onClick={()=>setScanning(true)} className="bg-gray-800 text-white p-3 rounded-xl"><i data-lucide="scan-barcode"></i></button>
                    </div>

                    {/* Liste D√©roulante Visuelle */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-2">
                        {filtered.length === 0 ? <div className="text-center text-gray-400 mt-10">Aucun produit trouv√©</div> : 
                        filtered.map(p => (
                            <div key={p.id} onClick={()=>addToCart(p)} className="bg-white p-4 rounded-xl border border-gray-200 flex justify-between items-center active:bg-orange-50 transition">
                                <div>
                                    <div className="font-bold text-gray-800">{p.name}</div>
                                    <div className="text-xs text-gray-500">Stock: {p.stock}</div>
                                </div>
                                <div className="font-black text-orange-600">{formatMoney(p.price)}</div>
                            </div>
                        ))}
                    </div>

                    {/* Panier */}
                    {cart.length > 0 && (
                        <div className="bg-white border-t p-4 shadow-up z-10">
                            <div className="flex justify-between items-end mb-3">
                                <span className="text-gray-500 font-bold">{cart.length} articles</span>
                                <span className="text-2xl font-black text-gray-900">{formatMoney(cart.reduce((a,i)=>a+(i.price*i.qty),0))}</span>
                            </div>
                            <button onClick={validateSale} className="w-full theme-orange py-4 rounded-xl font-black text-lg btn-press">
                                VALIDER LA VENTE
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        // --- MODULE : SERVICES (Reprographie) ---
        const ServicesModule = ({ services, onServiceSale, isAdmin, onUpdatePrice }) => {
            const [customPrice, setCustomPrice] = useState("");
            const [selectedService, setSelectedService] = useState(null);

            const handleServiceClick = (s) => {
                if(s.type === 'libre') {
                    const price = prompt("Entrez le montant du service :");
                    if(price && !isNaN(price)) {
                        onServiceSale({ ...s, price: parseInt(price) });
                    }
                } else {
                    onServiceSale(s);
                }
            };

            const adminEdit = (s) => {
                const newPrice = prompt(`Nouveau prix pour ${s.name} ?`, s.price);
                if(newPrice && !isNaN(newPrice)) onUpdatePrice(s.id, parseInt(newPrice));
            };

            return (
                <div className="p-4 grid grid-cols-2 gap-4">
                    {services.map(s => (
                        <div key={s.id} className="relative">
                            <button onClick={()=>handleServiceClick(s)} 
                                className={`w-full p-6 rounded-2xl flex flex-col items-center justify-center gap-2 shadow-sm btn-press ${s.type==='libre'?'bg-purple-100 text-purple-700':'bg-white text-gray-700'}`}>
                                <i data-lucide={s.type==='libre'?'edit-3':'printer'} className="w-8 h-8 mb-2"></i>
                                <span className="font-bold text-center leading-tight">{s.name}</span>
                                <span className="font-black bg-black/5 px-2 py-1 rounded-lg text-sm">
                                    {s.type === 'libre' ? 'PRIX LIBRE' : formatMoney(s.price)}
                                </span>
                            </button>
                            {isAdmin && s.type !== 'libre' && (
                                <button onClick={()=>adminEdit(s)} className="absolute top-2 right-2 bg-gray-200 p-2 rounded-full text-xs">
                                    <i data-lucide="settings" className="w-4 h-4"></i>
                                </button>
                            )}
                        </div>
                    ))}
                </div>
            );
        };

        // --- MODULE : ARRIVAGE STOCK (L'int√©gration Facture) ---
        const StockModule = ({ products, onRestock, onNewProduct }) => {
            // Mode "Nouvel Arrivage"
            const [mode, setMode] = useState('list'); // 'list' ou 'entry'
            const [entryItem, setEntryItem] = useState({ id: null, qty: '', buyPrice: '', sellPrice: '' });
            const [search, setSearch] = useState("");
            const [scanning, setScanning] = useState(false);

            // Trouver produit
            const foundProduct = products.find(p => p.id === entryItem.id);

            const handleScan = (code) => {
                const p = products.find(prod => prod.barcode === code);
                if(p) {
                    setEntryItem({ ...entryItem, id: p.id, sellPrice: p.price });
                } else {
                    if(confirm("Produit inconnu. Cr√©er ce nouveau produit ?")) {
                        const name = prompt("Nom du produit :");
                        if(name) {
                            const newP = { id: generateId(), barcode: code, name, stock: 0, price: 0 };
                            onNewProduct(newP);
                            setEntryItem({ ...entryItem, id: newP.id, sellPrice: 0 });
                        }
                    }
                }
                setScanning(false);
            };

            const addToStock = () => {
                if(!entryItem.id || !entryItem.qty) return alert("Remplir quantit√© !");
                onRestock(entryItem.id, parseInt(entryItem.qty), parseInt(entryItem.sellPrice));
                alert("Stock mis √† jour !");
                setEntryItem({ id: null, qty: '', buyPrice: '', sellPrice: '' }); // Reset
                setSearch("");
            };

            return (
                <div className="p-4 pb-20">
                    {scanning && <Scanner onScan={handleScan} onClose={()=>setScanning(false)} />}

                    <div className="bg-white p-6 rounded-3xl shadow-lg border-2 border-purple-100 mb-6">
                        <h2 className="text-xl font-black text-purple-700 mb-4 flex items-center gap-2">
                            <i data-lucide="package-plus"></i> SAISIE FACTURE / ARRIVAGE
                        </h2>
                        
                        {/* √âtape 1 : Choisir le produit */}
                        <div className="mb-4">
                            <label className="text-xs font-bold text-gray-500">1. IDENTIFIER PRODUIT</label>
                            <div className="flex gap-2 mt-1">
                                {foundProduct ? (
                                    <div className="flex-1 bg-purple-50 p-3 rounded-xl font-bold flex justify-between items-center border border-purple-200">
                                        <span>{foundProduct.name}</span>
                                        <button onClick={()=>setEntryItem({...entryItem, id: null})}><i data-lucide="x" className="text-red-500"></i></button>
                                    </div>
                                ) : (
                                    <>
                                        <select className="flex-1 bg-gray-100 p-3 rounded-xl font-bold" 
                                            onChange={(e) => {
                                                const p = products.find(x => x.id === e.target.value);
                                                if(p) setEntryItem({...entryItem, id: p.id, sellPrice: p.price});
                                            }}>
                                            <option value="">-- Choisir dans la liste --</option>
                                            {products.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                                        </select>
                                        <button onClick={()=>setScanning(true)} className="bg-black text-white p-3 rounded-xl"><i data-lucide="scan"></i></button>
                                    </>
                                )}
                            </div>
                        </div>

                        {/* √âtape 2 : Donn√©es Facture */}
                        {foundProduct && (
                            <div className="animate-fade-in space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-xs font-bold text-gray-500">QUANTIT√â (Facture)</label>
                                        <input type="number" value={entryItem.qty} onChange={e=>setEntryItem({...entryItem, qty: e.target.value})} 
                                            className="w-full bg-gray-100 p-3 rounded-xl font-black text-xl" placeholder="0" />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-500">PRIX VENTE (Unit√©)</label>
                                        <input type="number" value={entryItem.sellPrice} onChange={e=>setEntryItem({...entryItem, sellPrice: e.target.value})} 
                                            className="w-full bg-gray-100 p-3 rounded-xl font-black text-xl text-orange-600" />
                                    </div>
                                </div>
                                <button onClick={addToStock} className="w-full theme-purple py-4 rounded-xl font-bold text-white shadow-lg btn-press">
                                    VALIDER LA LIGNE
                                </button>
                            </div>
                        )}
                    </div>

                    <h3 className="font-bold text-gray-500 mb-2">√âtat du Stock Actuel</h3>
                    <div className="space-y-2">
                        {products.map(p => (
                            <div key={p.id} className="bg-white p-3 rounded-xl border border-gray-100 flex justify-between">
                                <span className="font-medium">{p.name}</span>
                                <span className={`font-bold ${p.stock<5?'text-red-500':'text-green-600'}`}>{p.stock} en stock</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- APPLICATION PRINCIPALE ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('sales'); // sales, services, stock, reports
            
            // Base de donn√©es locale
            const [products, setProducts] = useState(() => JSON.parse(localStorage.getItem('alisha_products')) || []);
            const [services, setServices] = useState(() => JSON.parse(localStorage.getItem('alisha_services')) || DEFAULT_SERVICES);
            const [transactions, setTransactions] = useState(() => JSON.parse(localStorage.getItem('alisha_transactions')) || []);

            // Sauvegarde automatique
            useEffect(() => {
                localStorage.setItem('alisha_products', JSON.stringify(products));
                localStorage.setItem('alisha_services', JSON.stringify(services));
                localStorage.setItem('alisha_transactions', JSON.stringify(transactions));
                lucide.createIcons();
            }, [products, services, transactions, view]);

            // --- ACTIONS ---
            const handleSale = (cartItems, total) => {
                // 1. D√©duire Stock
                const newProducts = products.map(p => {
                    const item = cartItems.find(c => c.id === p.id);
                    return item ? { ...p, stock: p.stock - item.qty } : p;
                });
                setProducts(newProducts);
                
                // 2. Enregistrer Transaction
                const tx = { id: generateId(), type: 'SALE', amount: total, desc: `Vente ${cartItems.length} art.`, date: Date.now(), by: user.name };
                setTransactions([tx, ...transactions]);
            };

            const handleServiceSale = (service) => {
                if(confirm(`Confirmer ${service.name} pour ${formatMoney(service.price)} ?`)) {
                    const tx = { id: generateId(), type: 'SERVICE', amount: service.price, desc: service.name, date: Date.now(), by: user.name };
                    setTransactions([tx, ...transactions]);
                    alert("Service encaiss√© !");
                }
            };

            const handleRestock = (prodId, qty, newPrice) => {
                setProducts(products.map(p => p.id === prodId ? { ...p, stock: p.stock + qty, price: newPrice || p.price } : p));
                // Optionnel : Enregistrer une transaction "ACHAT" si on g√©rait la caisse d√©pense
            };

            const handleNewProduct = (prod) => setProducts([...products, prod]);

            const handleUpdateServicePrice = (id, price) => {
                setServices(services.map(s => s.id === id ? {...s, price} : s));
            };

            // --- RAPPORT WHATSAPP ---
            const generateReport = () => {
                const todayTx = transactions.filter(t => new Date(t.date).toLocaleDateString() === new Date().toLocaleDateString());
                const totalVente = todayTx.filter(t => t.type === 'SALE').reduce((a,t)=>a+t.amount,0);
                const totalService = todayTx.filter(t => t.type === 'SERVICE').reduce((a,t)=>a+t.amount,0);
                
                const text = `
*RAPPORT ALISHASHOP - ${todayStr()}*
üë§ Vendeur: ${user.name}
-------------------------
üõçÔ∏è Ventes Boutique: ${formatMoney(totalVente)}
üñ®Ô∏è Services: ${formatMoney(totalService)}
-------------------------
üí∞ *TOTAL JOURNALIER: ${formatMoney(totalVente + totalService)}*
`.trim();
                
                const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
                window.open(url, '_blank');
            };

            if(!user) return <LoginScreen onLogin={setUser} />;

            return (
                <div className="max-w-md mx-auto h-screen bg-gray-50 flex flex-col relative shadow-2xl">
                    {/* EN-T√äTE */}
                    <div className="bg-white p-4 flex justify-between items-center shadow-sm z-10">
                        <div className="flex items-center gap-2">
                            <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white font-bold ${user.role==='admin'?'bg-orange-600':'bg-blue-600'}`}>
                                {user.name[0]}
                            </div>
                            <div>
                                <h2 className="font-bold text-sm">{user.name}</h2>
                                <p className="text-xs text-gray-500">{user.role === 'admin' ? 'G√©rant' : 'Vendeur'}</p>
                            </div>
                        </div>
                        <button onClick={()=>setUser(null)} className="p-2 bg-gray-100 rounded-lg"><i data-lucide="log-out" className="w-4 h-4"></i></button>
                    </div>

                    {/* CONTENU VARIABLE */}
                    <div className="flex-1 overflow-y-auto bg-gray-50 relative">
                        {view === 'sales' && <ShopModule products={products} onSale={handleSale} />}
                        {view === 'services' && <ServicesModule services={services} onServiceSale={handleServiceSale} isAdmin={user.role==='admin'} onUpdatePrice={handleUpdateServicePrice} />}
                        {view === 'stock' && user.role === 'admin' && <StockModule products={products} onRestock={handleRestock} onNewProduct={handleNewProduct} />}
                        
                        {view === 'reports' && (
                            <div className="p-6">
                                <h2 className="text-2xl font-black mb-6">Bilan du Jour</h2>
                                <div className="bg-white p-6 rounded-3xl shadow-lg text-center mb-6">
                                    <p className="text-gray-500 font-bold">Chiffre d'Affaires</p>
                                    <p className="text-4xl font-black text-green-600 mt-2">
                                        {formatMoney(transactions.filter(t => new Date(t.date).toLocaleDateString() === new Date().toLocaleDateString()).reduce((a,t)=>a+t.amount,0))}
                                    </p>
                                </div>
                                <button onClick={generateReport} className="w-full py-4 bg-green-500 text-white font-bold rounded-xl flex items-center justify-center gap-2 shadow-lg btn-press">
                                    <i data-lucide="send"></i> ENVOYER SUR WHATSAPP
                                </button>
                                <div className="mt-8">
                                    <h3 className="font-bold text-gray-600 mb-4">Historique R√©cent</h3>
                                    {transactions.slice(0, 10).map(t => (
                                        <div key={t.id} className="flex justify-between py-3 border-b border-gray-100 text-sm">
                                            <span>{t.desc}</span>
                                            <span className="font-bold">{formatMoney(t.amount)}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {view === 'stock' && user.role !== 'admin' && (
                            <div className="h-full flex items-center justify-center text-gray-400 font-bold p-10 text-center">
                                Acc√®s r√©serv√© au G√©rant
                            </div>
                        )}
                    </div>

                    {/* BARRE DE NAVIGATION */}
                    <div className="bg-white p-2 flex justify-around border-t pb-safe">
                        <button onClick={()=>setView('sales')} className={`p-3 rounded-xl flex flex-col items-center gap-1 ${view==='sales'?'text-orange-600 bg-orange-50': 'text-gray-400'}`}>
                            <i data-lucide="shopping-cart"></i> <span className="text-[10px] font-bold">Vente</span>
                        </button>
                        <button onClick={()=>setView('services')} className={`p-3 rounded-xl flex flex-col items-center gap-1 ${view==='services'?'text-blue-600 bg-blue-50': 'text-gray-400'}`}>
                            <i data-lucide="printer"></i> <span className="text-[10px] font-bold">Services</span>
                        </button>
                        <button onClick={()=>setView('stock')} className={`p-3 rounded-xl flex flex-col items-center gap-1 ${view==='stock'?'text-purple-600 bg-purple-50': 'text-gray-400'}`}>
                            <i data-lucide="package"></i> <span className="text-[10px] font-bold">Stock</span>
                        </button>
                        <button onClick={()=>setView('reports')} className={`p-3 rounded-xl flex flex-col items-center gap-1 ${view==='reports'?'text-green-600 bg-green-50': 'text-gray-400'}`}>
                            <i data-lucide="bar-chart-2"></i> <span className="text-[10px] font-bold">Bilan</span>
                        </button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
